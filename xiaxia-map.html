<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Xianxia Infinite Realm</title>
<style>
    :root {
        /* --- THEME --- */
        --bg: #0b0f14;
        --panel: #121923;
        --border: #30363d;
        --text: #e6edf3;
        --gold: #eac54f;
        --accent: #d2a8ff;
        --danger: #ff6b6b;

        /* --- BIOME PALETTE (Strict Identity) --- */
        --c-void: #050d14;         /* Abyssal Sea */
        --c-water: #0f2c45;        /* Spirit Ocean */
        --c-coast: #1e3a2f;        /* Shallow/Coast */
        
        --c-plains: #1a3d1a;       /* Spirit Plains (Green) */
        
        --c-forest: #0d1f0d;       /* Deep Forest */
        --c-jade: #062b21;         /* Jade Forest (Rare) */
        
        --c-desert: #3d341a;       /* Dune Sea (Yellow/Brown) */
        --c-badland: #3d221a;      /* Red Wastes */
        
        --c-mtn: #2b2b2b;          /* Spirit Mountain */
        --c-peak: #f0f6fc;         /* Heavenly Peak (Snow) */
        --c-volcano: #5c1818;      /* Volcano */
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

    body {
        margin: 0;
        background-color: var(--bg);
        color: var(--text);
        font-family: 'Segoe UI', system-ui, sans-serif;
        height: 100dvh; /* Mobile viewport fix */
        overflow: hidden;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    /* --- LAYOUT CONTAINER --- */
    .game-container {
        width: 100%;
        max-width: 600px;
        height: 100%;
        display: flex;
        flex-direction: column;
        border-left: 1px solid var(--border);
        border-right: 1px solid var(--border);
        background: var(--panel);
        position: relative;
    }

    /* --- HEADER --- */
    .header {
        padding: 15px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        background: #000;
        flex-shrink: 0;
        z-index: 10;
        box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    .coords-label { font-size: 0.6rem; color: #666; letter-spacing: 2px; font-weight: bold; margin-bottom: 2px; }
    .coords-val { font-family: monospace; color: var(--gold); font-size: 1.2rem; font-weight: bold; }
    
    .status-box { text-align: right; }
    .biome-name { color: var(--accent); font-weight: bold; font-size: 0.95rem; }

    /* --- MAP VIEWPORT --- */
    .map-viewport {
        flex-grow: 1;
        min-height: 0;
        background: #050505;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .grid {
        display: grid;
        grid-template-columns: repeat(11, 1fr); 
        grid-template-rows: repeat(11, 1fr);
        width: 100%;
        max-width: 500px;
        aspect-ratio: 1/1;
        /* Gap 0 for seamless terrain look */
        gap: 0; 
    }

    /* --- TILES & ANIMATION --- */
    .tile {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: clamp(14px, 4.5vw, 24px);
        cursor: pointer;
        position: relative;
        border: 0.5px solid rgba(0,0,0,0.1); /* Subtle grid line */
        
        /* THE ANIMATION FEEL (from Map-Main) */
        transition: transform 0.1s cubic-bezier(0.2, 0.8, 0.2, 1), filter 0.1s;
        user-select: none;
    }

    .tile:hover {
        filter: brightness(1.3);
        z-index: 10;
        transform: scale(1.1);
        box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        border: 1px solid var(--accent);
    }

    .tile:active {
        transform: scale(0.92);
        filter: brightness(0.8);
    }

    .center-tile {
        outline: 2px solid var(--gold);
        outline-offset: -2px;
        z-index: 5;
        box-shadow: inset 0 0 15px rgba(234, 197, 79, 0.4);
    }

    /* Edict Marker */
    .tile.has-note::after {
        content: ''; position: absolute; top: 4px; right: 4px;
        width: 5px; height: 5px; background: var(--gold);
        border-radius: 50%; box-shadow: 0 0 4px var(--gold);
    }

    /* --- CONTROLS --- */
    .controls {
        padding: 15px;
        padding-bottom: max(15px, env(safe-area-inset-bottom));
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        background: var(--panel);
        border-top: 1px solid var(--border);
        flex-shrink: 0;
        z-index: 20;
    }

    .d-pad { display: grid; grid-template-columns: 60px 60px 60px; gap: 8px; }

    button {
        background: #21262d; 
        border: 1px solid var(--border); 
        color: var(--text);
        padding: 12px; 
        border-radius: 8px; 
        cursor: pointer; 
        font-size: 18px;
        touch-action: manipulation; 
        transition: all 0.15s;
    }
    
    button:active { 
        background: var(--accent); 
        color: #000; 
        transform: translateY(2px);
    }
    
    .action-bar { display: flex; gap: 10px; width: 100%; justify-content: center; }
    .btn-sm { 
        font-size: 11px; 
        padding: 10px 15px; 
        text-transform: uppercase; 
        font-weight: bold; 
        letter-spacing: 0.5px;
        flex: 1;
        max-width: 160px;
    }

    .seed-display {
        font-size: 10px; color: #555; font-family: monospace; margin-top: 5px;
    }

    /* --- NOTEBOOK MODAL --- */
    #notebook-modal {
        position: absolute; bottom: 0; left: 0; right: 0; height: 55%;
        background: #0d1117; border-top: 2px solid var(--gold); padding: 20px;
        transform: translateY(100%); 
        transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); /* Apple-style spring */
        display: flex; flex-direction: column; z-index: 100; 
        box-shadow: 0 -20px 50px rgba(0,0,0,0.8);
    }
    #notebook-modal.active { transform: translateY(0); }

    .modal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
    .note-title { font-weight: bold; color: var(--gold); font-size: 1.2rem; }
    .note-desc { font-style: italic; color: #888; font-size: 0.85em; margin-top: 4px; }
    
    textarea {
        width: 100%; flex-grow: 1; background: #161b22; border: 1px solid var(--border);
        color: var(--text); padding: 15px; resize: none; margin-bottom: 15px;
        font-family: 'Courier New', Courier, monospace; outline: none; border-radius: 4px;
    }
    textarea:focus { border-color: var(--gold); }
    
    .save-btn { background: var(--gold); color: #000; font-weight: bold; border: none; padding: 15px; border-radius: 6px; cursor: pointer; }
    .close-btn { background: none; border: 1px solid #444; font-size: 11px; padding: 4px 12px; color: #888; border-radius: 12px; }

</style>
</head>
<body>

<div class="game-container">
    <div class="header">
        <div>
            <div class="coords-label">DIVINE SENSE</div>
            <div class="coords-val" id="coords-display">0, 0</div>
        </div>
        <div class="status-box">
            <div class="biome-name" id="biome-display">Initializing...</div>
        </div>
    </div>

    <div class="map-viewport">
        <div class="grid" id="grid"></div>
    </div>

    <div class="controls">
        <div class="d-pad">
            <div></div><button onclick="move(0, -1)">‚ñ≤</button><div></div>
            <button onclick="move(-1, 0)">‚óÄ</button>
            <button onclick="zoom()" title="Inspect Location" style="font-size: 20px;">üëÅÔ∏è</button> 
            <button onclick="move(1, 0)">‚ñ∂</button>
            <div></div><button onclick="move(0, 1)">‚ñº</button><div></div>
        </div>
        <div class="action-bar">
            <button class="btn-sm" onclick="teleport()">‚ú® Void Drift</button>
            <button class="btn-sm" onclick="reincarnate()">üé≤ Reincarnate</button>
        </div>
        <div class="seed-display" id="seed-display">Seed: 000000</div>
    </div>
</div>

<div id="notebook-modal">
    <div class="modal-header">
        <div>
            <div class="note-title" id="note-title">Location Name</div>
            <div class="note-desc" id="note-desc">Description...</div>
        </div>
        <button class="close-btn" onclick="closeNotebook()">CLOSE</button>
    </div>
    <textarea id="note-input" placeholder="Record the Dao of this location..."></textarea>
    <button class="save-btn" onclick="saveNote()">SCRIBE EDICT</button>
</div>

<script>
    // --- 1. CORE ENGINE & SEEDING ---
    // Start with a random seed
    let SEED = Math.floor(Math.random() * 899999) + 100000;
    
    // Player State
    const S = { x: 0, y: 0, ledger: {} };

    // Basic Hash (Pseudorandom)
    function hash(x, y) {
        let n = Math.sin(x * 12.9898 + y * 78.233 + SEED) * 43758.5453;
        return n - Math.floor(n);
    }

    // Smooth Noise (Bilinear Interpolation)
    function noise(x, y) {
        let i = Math.floor(x);
        let j = Math.floor(y);
        let u = x - i;
        let v = y - j;
        
        // Quintic curve for smoother interpolation
        u = u * u * u * (u * (u * 6 - 15) + 10);
        v = v * v * v * (v * (v * 6 - 15) + 10);
        
        return (1-u)*(1-v)*hash(i, j) + 
               u*(1-v)*hash(i+1, j) + 
               (1-u)*v*hash(i, j+1) + 
               u*v*hash(i+1, j+1);
    }

    // Fractal Brownian Motion (Octaves for detail)
    function fbm(x, y, octaves) {
        let val = 0;
        let amp = 0.5;
        let freq = 1;
        
        for(let i=0; i<octaves; i++){
            val += noise(x*freq, y*freq) * amp;
            amp *= 0.5;
            freq *= 2;
        }
        return val;
    }

    // --- 2. WORLD LOGIC (THE MERGE) ---
    
    // Helper: Determine if a tile is a Settlement
    // FIX: Added 'e' parameter to check neighbor elevation for Port Cities
    function getSettlement(x, y, e) {
        let h = hash(x, y);
        
        // --- PORT CITY LOGIC (With Neighbor Check) ---
        // 1. Is it rare? (h > 0.98) 
        // 2. Is it in the coastal elevation band? (0.35 - 0.38)
        if (h > 0.98 && e >= 0.35 && e < 0.38) {
            const scale = 0.04;
            // 3. NEIGHBOR CHECK: Is it actually touching water? (e < 0.35)
            // We check the 4 cardinal neighbors.
            let n1 = fbm((x+1) * scale, y * scale, 4);
            let n2 = fbm((x-1) * scale, y * scale, 4);
            let n3 = fbm(x * scale, (y+1) * scale, 4);
            let n4 = fbm(x * scale, (y-1) * scale, 4);
            
            if (n1 < 0.35 || n2 < 0.35 || n3 < 0.35 || n4 < 0.35) {
                return { type: 'Port City', name: 'Port City', icon: '‚öì', desc: 'Trade hub of the Seas.', isPort: true };
            }
        }

        // Standard Settlements
        if (h > 0.992) return { type: 'City', name: 'Imperial Capital', icon: 'üèØ', desc: 'A vast metropolis of millions of people.' };
        if (h > 0.975) return { type: 'City', name: 'City', icon: 'üèôÔ∏è', desc: 'A city teeming with mortals and merchants.' };
        if (h > 0.960) return { type: 'Sect', name: 'Sect', icon: '‚õ©Ô∏è', desc: 'A center of cultivation power.' };
        if (h > 0.945) return { type: 'Fortress', name: 'Fortress', icon: 'üè∞', desc: 'A military stronghold guarding the lands.' };
        if (h > 0.944) return { type: 'Ruins', name: 'Ruins', icon: 'üõï', desc: 'Echoes of a fallen civilization.' };
        if (h > 0.860) return { type: 'Village', name: 'Village', icon: 'üè°', desc: 'A humble settlement of mortals.' };
        
        return null;
    }

    function getTileData(x, y) {
        const scale = 0.04; // 10km scale feel
        
        // 1. GENERATE LAYERS
        let e = fbm(x * scale, y * scale, 4);       // Elevation
        let m = fbm(x * scale + 500, y * scale + 500, 2); // Moisture
        let q = fbm(x * 0.02 - 100, y * 0.02 - 100, 2);   // Qi (Lower freq for vast zones)

        // 2. BASE BIOME
        let data = { 
            color: 'var(--c-plains)', 
            name: 'Spirit Plains', 
            icon: '', 
            desc: 'Vast grasslands',
            cssClass: ''
        };

        // --- WATER (Logic from Zero1 + Zero11) ---
        if (e < 0.22) {
            data.color = 'var(--c-void)'; data.name = 'Abyssal Sea'; data.desc = 'Crushing depths where light dies.';
        } else if (e < 0.35) {
            data.color = 'var(--c-water)'; data.name = 'Ocean'; data.desc = 'Endless water.';
        } 
        
        // FIX: Removed broken "Port City" block here. It is now handled in getSettlement.
        
        // --- MOUNTAINS (Distinct Ranges) ---
        else if (e > 0.79) {
            // Volcano Check: High Peak but Very Unstable Qi (q < 0.2)
            if (q < 0.2) {
                data.color = 'var(--c-volcano)'; data.name = 'Volcano'; data.icon = 'üåã'; data.desc = 'Magma flows and ash clouds.';
            } else {
                data.color = 'var(--c-peak)'; data.name = 'Heavenly Peak'; data.icon = 'üèîÔ∏è'; data.desc = 'The air is thin and pure here.';
            }
        } else if (e > 0.65) {
            data.color = 'var(--c-mtn)'; data.name = 'Spirit Mountain'; data.icon = '‚õ∞Ô∏è'; data.desc = 'Jagged ridges and hidden caves.';
        }
        
        // --- LAND (Vegetation & Qi) ---
        else {
            // Desert (Low M, High E to avoid beaches being deserts)
            if (m < 0.2 && e > 0.45) {
                data.color = 'var(--c-desert)'; data.name = 'Dune Sea'; data.desc = 'Endless golden sands.';
                // Badlands if extremely dry
                if (m < 0.1) { data.color = 'var(--c-badland)'; data.name = 'Red Wastes'; }
            }
            // Forests
            else if (m > 0.65) {
                // Jade Forest: The rare "Triple Gate"
                if (q > 0.75 && e > 0.45 && e < 0.7) {
                    data.color = 'var(--c-jade)'; data.name = 'Jade Forest'; data.desc = 'Bamboo groves glowing with ancient Qi.';
                } else {
                    data.color = 'var(--c-forest)'; data.name = 'Deep Forest'; data.desc = 'An ancient, canopied wilderness.';
                }
            }
            
            // --- OVERLAYS: SETTLEMENTS ---
            // Only on habitable land (Plains, Forests, Deserts)
            // FIX: Passing 'e' to check for Port Cities
            let s = getSettlement(x, y, e);
            if (s) {
                data.icon = s.icon; data.name = s.name; data.desc = s.desc;
                // FIX: Force background color if it's a Port City
                if (s.isPort) data.color = 'var(--c-coast)';
            }
        }

        return data;
    }

    // --- 3. RENDER ENGINE ---
    const gridEl = document.getElementById('grid');
    const coordsEl = document.getElementById('coords-display');
    const biomeEl = document.getElementById('biome-display');
    const seedEl = document.getElementById('seed-display');

    function renderMap() {
        gridEl.innerHTML = '';
        const range = 5; // 11x11 grid
        
        for (let y = S.y - range; y <= S.y + range; y++) {
            for (let x = S.x - range; x <= S.x + range; x++) {
                const data = getTileData(x, y);
                const tile = document.createElement('div');
                
                tile.className = `tile ${data.cssClass}`;
                if (x === S.x && y === S.y) tile.classList.add('center-tile');
                if (S.ledger[`${x},${y}`]) tile.classList.add('has-note');

                tile.style.backgroundColor = data.color;
                tile.innerText = data.icon;
                
                // Click Event
                tile.onclick = () => openNotebook(x, y, data);
                
                gridEl.appendChild(tile);
            }
        }

        // Update Header Info
        const currentTile = getTileData(S.x, S.y);
        coordsEl.innerText = `${S.x}, ${S.y}`;
        biomeEl.innerText = currentTile.name;
    }

    // --- 4. MOVEMENT & ACTIONS ---
    function move(dx, dy) {
        if(modal.classList.contains('active')) return;
        S.x += dx;
        S.y += dy;
        renderMap();
    }

    function zoom() {
        if(modal.classList.contains('active')) return;
        openNotebook(S.x, S.y, getTileData(S.x, S.y));
    }

    function teleport() {
        S.x += Math.floor((Math.random() - 0.5) * 5000);
        S.y += Math.floor((Math.random() - 0.5) * 5000);
        renderMap();
    }

    function reincarnate() {
        if(confirm("Abandon this timeline and reincarnate into a new world?")) {
            SEED = Math.floor(Math.random() * 899999) + 100000;
            seedEl.innerText = `Seed: ${SEED}`;
            S.x = 0; S.y = 0; S.ledger = {};
            renderMap();
        }
    }

    // --- 5. NOTEBOOK SYSTEM ---
    const modal = document.getElementById('notebook-modal');
    const nTitle = document.getElementById('note-title');
    const nDesc = document.getElementById('note-desc');
    const nInput = document.getElementById('note-input');
    let currentEdit = {x:0, y:0};

    function openNotebook(x, y, data) {
        currentEdit = {x, y};
        nTitle.innerText = `${data.icon || 'üìç'} ${data.name}  (${x}, ${y})`;
        nDesc.innerText = `${data.desc}`;
        nInput.value = S.ledger[`${x},${y}`] || "";
        modal.classList.add('active');
    }

    function saveNote() {
        const val = nInput.value.trim();
        const key = `${currentEdit.x},${currentEdit.y}`;
        if (val) S.ledger[key] = val;
        else delete S.ledger[key];
        closeNotebook();
        renderMap(); // Update marker
    }

    function closeNotebook() {
        modal.classList.remove('active');
        nInput.blur(); // Fix mobile keyboard
    }

    // --- INITIALIZATION ---
    seedEl.innerText = `Seed: ${SEED}`;
    renderMap();

    // Keyboard Controls
    document.addEventListener('keydown', (e) => {
        if (modal.classList.contains('active')) return;
        const k = e.key.toLowerCase();
        if (k === 'arrowup' || k === 'w') move(0, -1);
        if (k === 'arrowdown' || k === 's') move(0, 1);
        if (k === 'arrowleft' || k === 'a') move(-1, 0);
        if (k === 'arrowright' || k === 'd') move(1, 0);
        if (k === 'enter' || k === ' ') zoom();
    });

</script>
</body>
</html>
